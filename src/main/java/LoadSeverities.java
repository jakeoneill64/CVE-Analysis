import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;

import java.io.*;

import java.util.*;

public class LoadSeverities {

    public CVEEntry[] parseJSON(File... JSONs) {
        List<CVEEntry> cves = new LinkedList<>();
        for (File JSON : JSONs) {
            StringBuilder builder = new StringBuilder();
            try (Scanner scan = new Scanner(JSON)) {
                while (scan.hasNextLine())
                    builder.append(scan.nextLine());
            } catch (IOException e) {
                e.printStackTrace();
            }
            JSONToList<CVEEntry> parser = (String s) -> {
                ObjectMapper mapper = new ObjectMapper();
                try {
                    JsonNode jsonNode = mapper.readValue(s, JsonNode.class);
                    JsonNode cve_array = jsonNode.get("CVE_Items");
                    Iterator<JsonNode> i = cve_array.iterator();
                    //Iterate through the JSON tree to find relevant entries
                    while (i.hasNext()) {
                        CVEEntry x = (CVEEntry) Launch.getContext().getBean("CVEEntry");
                        try {
                            JsonNode cve = i.next();
                            JsonNode impact = cve.get("impact");
                            JsonNode baseMetricV2 = impact.get("baseMetricV2");
                            JsonNode severity = baseMetricV2.get("severity");
                            JsonNode publishedDate = cve.get("publishedDate");
                            x.setSeverity(severity.toString().substring(1, severity.toString().length() - 1));
                            x.setPublishedDate(publishedDate.toString().substring(1, 11));
                        } catch (NullPointerException e) {
                            //Some of the cve entries are invalid
                            continue;
                        }
                        cves.add(x);

                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
                return cves;
            };
        }
        return cves.toArray(new CVEEntry[0]);
    }
}