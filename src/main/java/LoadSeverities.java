import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;

import java.io.*;

import java.util.*;

public class LoadSeverities {

    public CVEEntry[] parseJSON(File... JSONs) {
        List<CVEEntry> cve_arr = new LinkedList<>();
        JSONToList<CVEEntry> parser = (String s, List<CVEEntry> cves) -> {
            ObjectMapper mapper = new ObjectMapper();
            try {
                JsonNode jsonNode = mapper.readValue(s, JsonNode.class);
                JsonNode cve_array = jsonNode.get("CVE_Items");
                Iterator<JsonNode> i = cve_array.iterator();
                //Iterate through the JSON tree to find relevant entries
                while (i.hasNext()) {
                    CVEEntry x = new CVEEntry();
                    try {
                        JsonNode cve = i.next();
                        JsonNode impact = cve.get("impact");
                        JsonNode baseMetricV2 = impact.get("baseMetricV2");
                        JsonNode severity = baseMetricV2.get("severity");
                        JsonNode publishedDate = cve.get("publishedDate");
                        x.setSeverity(severity.toString().substring(1, severity.toString().length() - 1));
                        x.setPublishedDate(publishedDate.toString().substring(1, 11));
                    } catch (NullPointerException e) {
                        //Some of the cve entries are invalid
                        continue;
                    }
                    cves.add(x);
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
            return cves;
        };
        for(File JSON:JSONs) {
            StringBuilder builder = new StringBuilder();
            try (Scanner scan = new Scanner(JSON)) {
                while (scan.hasNextLine())
                    builder.append(scan.nextLine());
            } catch (IOException e) {
                e.printStackTrace();
            }
            cve_arr = parser.toObjectList(builder.toString(), cve_arr);
        }
        CVEEntry[] out = cve_arr.toArray(new CVEEntry[0]);
        Arrays.sort(out, CVEEntry.orderFactory(1));
        return out;
    }
}