import java.io.*;
import java.time.LocalDate;
import java.time.Month;
import java.util.Arrays;
import java.util.HashMap;


/**
 * Get severity quantities by month. prototype
 */
public class MonthlySeverities implements Serializable, DataByPeriod<Severity, Integer> {

    private class CVEWrap implements Serializable {
        CVEEntry[] totalseverities;
    }

    private CVEWrap severities;
    private static final File[] JSON_FILES = {
            new File(System.getProperty("user.dir") + "/res/nvdcve-1.1-2015.json"),
            new File(System.getProperty("user.dir") + "/res/nvdcve-1.1-2016.json"),
            new File(System.getProperty("user.dir") + "/res/nvdcve-1.1-2017.json"),
            new File(System.getProperty("user.dir") + "/res/nvdcve-1.1-2018.json"),
            new File(System.getProperty("user.dir") + "/res/nvdcve-1.1-2019.json"),
            new File(System.getProperty("user.dir") + "/res/nvdcve-1.1-2020.json")
    };


    private CVEWrap deserialise(File f)  {
        try(ObjectInputStream in = new ObjectInputStream(new FileInputStream(f))){
            severities = (CVEWrap) in.readObject();
            return severities;
        }catch(IOException | ClassNotFoundException e){
            e.printStackTrace();
        }
        return null;
    }

    private void serialise(File f){
        try(ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(f))){
            out.writeObject(severities);
        }catch(IOException e){
            e.printStackTrace();
        }
    }

    private void load() {
        File f = new File(System.getProperty("user.dir") + "/res/cache/severities.obj");
        if(f.exists())
            if(Launch.getCaching()){
                severities = deserialise(f);
                return;
        }
        LoadSeverities loader = (LoadSeverities) Launch.getContext().getBean("LoadSeverities");
        severities = new CVEWrap();
        severities.totalseverities = loader.parseJSON(JSON_FILES);
        serialise(f);
    }

    private int[] getArrayIndicies(Month m, int year){
        LocalDate start, end;
        if(m != null) {
            start = LocalDate.of(year, m, 1);
            end = start.plusMonths(1);
        }else{
            start = LocalDate.of(year, Month.JANUARY, 1);
            end = start.plusYears(1);
        }
        CVEEntry a = new CVEEntry(), b = new CVEEntry();
        a.setPublishedDate(start); b.setPublishedDate(end);
        int indexstart, indexend;
        indexstart = Arrays.binarySearch(severities.totalseverities, a, CVEEntry.orderFactory(1));
        indexend = Arrays.binarySearch(severities.totalseverities, b, CVEEntry.orderFactory(1));
        if(indexstart < 0)
            indexstart = -indexstart -1;
        if(indexend < 0)
            indexend = -indexend -2;
        return new int[]{indexstart, indexend};
    }

    public HashMap<Severity, Integer> getYear(int year){
        HashMap<Severity, Integer> yearly = new HashMap<>();
        yearly.put(Severity.HIGH, 0);
        yearly.put(Severity.MEDIUM, 0);
        yearly.put(Severity.LOW, 0);
        int[] indicies = getArrayIndicies(null, year);
        for(int i = indicies[0]; i <= indicies[1]; i++) {
            yearly.put(severities.totalseverities[i].getSeverity(), yearly.get(severities.totalseverities[i].getSeverity()) +1);
        }
        return yearly;
    }

    public HashMap<Severity, Integer> getMonth(Month m, int year) {
        HashMap<Severity, Integer> monthly = new HashMap<>();
        monthly.put(Severity.HIGH, 0);
        monthly.put(Severity.MEDIUM, 0);
        monthly.put(Severity.LOW, 0);
        int[] indicies = getArrayIndicies(m, year);
        for(int i = indicies[0]; i <= indicies[1]; i++) {
            monthly.put(severities.totalseverities[i].getSeverity(), monthly.get(severities.totalseverities[i].getSeverity()) +1);
        }
        return monthly;
    }

}
