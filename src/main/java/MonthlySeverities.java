import java.io.*;
import java.time.LocalDate;
import java.time.Month;
import java.util.*;


/**
 * Fetches severity quantities by period.
 */
public class MonthlySeverities implements Serializable, DataByPeriod<Severity, Integer> {

    private class CVEWrap implements Serializable {
        CVEEntry[] totalseverities;
    }
    private CVEWrap severities;

    /**Fetch cached CVEs
     *
     * @param f cached file
     * @return
     */
    private CVEWrap deserialise(File f)  {
        try(ObjectInputStream in = new ObjectInputStream(new FileInputStream(f))){
            severities = (CVEWrap) in.readObject();
            return severities;
        }catch(IOException | ClassNotFoundException e){
            e.printStackTrace();
        }
        return null;
    }

    /**Cache the Loaded CVEs
     *
     * @param f object file
     */
    private void serialise(File f){
        try(ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(f))){
            out.writeObject(severities);
        }catch(IOException e){
            e.printStackTrace();
        }
    }

    /**
     * Initialisation method for monthly severities.
     * Uses cached CVE Array if specified.
     */
    private void load() {
        File f = new File(System.getProperty("user.dir") + "./cache/severities.obj");
        System.out.println();
        //Should I cache?
        if(f.exists())
            if(Launch.getCaching()){
                severities = deserialise(f);
                return;
        }
        LoadSeverities loader = (LoadSeverities) Launch.getContext().getBean("LoadSeverities");
        severities = new CVEWrap();
        //Use SeveritiesLoader to load the Json files into a CVEEntry array
        severities.totalseverities = loader.parseJSON(Launch.JSONs);
        serialise(f);
    }


    /**Calulate the indicies for the period in the Loaded CVE Array
     *
     * @param m if == null get the indicies for the year
     * @param year
     * @return
     */
    private int[] getArrayIndicies(Month m, int year){
        LocalDate start, end;
        if(m != null) {
            start = LocalDate.of(year, m, 1);
            end = start.plusMonths(1);
        }else{
            start = LocalDate.of(year, Month.JANUARY, 1);
            end = start.plusYears(1);
        }
        //Binary search for boundries using contrived CVEEntries
        CVEEntry a = new CVEEntry(), b = new CVEEntry();
        a.setPublishedDate(start); b.setPublishedDate(end);
        int indexstart, indexend;
        indexstart = Arrays.binarySearch(severities.totalseverities, a, CVEEntry.orderFactory(1));
        indexend = Arrays.binarySearch(severities.totalseverities, b, CVEEntry.orderFactory(1));
        //if not found use binary return values to find indicies
        if(indexstart < 0)
            indexstart = -indexstart -1;
        if(indexend < 0)
            indexend = -indexend -2;
        return new int[]{indexstart, indexend};
    }

    /**Fetch the number of severities by year
     *
     * @param year
     * @return the number of severity occurences
     */
    public HashMap<Severity, Integer> getYear(int year){
        HashMap<Severity, Integer> yearly = new HashMap<>();
        yearly.put(Severity.HIGH, 0);
        yearly.put(Severity.MEDIUM, 0);
        yearly.put(Severity.LOW, 0);
        int[] indicies = getArrayIndicies(null, year);
        //put all severity occurances from subset of cve array into a map.
        for(int i = indicies[0]; i <= indicies[1]; i++) {
            yearly.put(severities.totalseverities[i].getSeverity(), yearly.get(severities.totalseverities[i].getSeverity()) +1);
        }
        return yearly;
    }

    /**Fetch the number of severities by month
     *
     * @param m
     * @param year
     * @return the number of severity occurences
     */
    public HashMap<Severity, Integer> getMonth(Month m, int year) {
        HashMap<Severity, Integer> monthly = new HashMap<>();
        monthly.put(Severity.HIGH, 0);
        monthly.put(Severity.MEDIUM, 0);
        monthly.put(Severity.LOW, 0);
        int[] indicies = getArrayIndicies(m, year);
        //put all severity occurances from subset of cve array into a map.
        for(int i = indicies[0]; i <= indicies[1]; i++) {
            monthly.put(severities.totalseverities[i].getSeverity(), monthly.get(severities.totalseverities[i].getSeverity()) +1);
        }
        return monthly;
    }

}
