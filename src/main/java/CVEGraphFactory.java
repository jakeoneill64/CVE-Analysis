import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.axis.CategoryAxis;
import org.jfree.chart.axis.DateAxis;
import org.jfree.chart.axis.NumberAxis;
import org.jfree.chart.axis.ValueAxis;
import org.jfree.chart.plot.CategoryPlot;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.plot.XYPlot;
import org.jfree.chart.renderer.category.CategoryItemRenderer;
import org.jfree.chart.ui.ApplicationFrame;
import org.jfree.data.general.Dataset;
import org.jfree.data.general.DatasetUtils;
import org.jfree.data.time.TimeTableXYDataset;
import org.jfree.data.time.Month;

import javax.swing.*;
import java.awt.*;
import java.time.LocalDate;
import java.util.Map;

import java.util.HashMap;

/*Graph factory is dependent on JFreeChart Library
 */

//TODO High Level depencies and unncessary imports
public class CVEGraphFactory{

    private TimeTableXYDataset stackeddata;
    private Integer[][] griddata;

    private CVEGraphFactory(){

    }

    private void initialise(){
        DataByPeriod<Severity, Integer> data = (DataByPeriod)Launch.getContext().getBean("DataByPeriod");
        stackeddata = new TimeTableXYDataset();
        griddata = new Integer[6][4];
        for(int i = 0; i < (12*6); i++){
            java.time.Month current = java.time.Month.of((i % 12) +1);
            int year = 2015+(i / 12);
            Map<Severity, Integer> map = data.getMonth(current, year);
            stackeddata.add(new Month(current.ordinal() + 1, year), map.get(Severity.HIGH), "High");
            stackeddata.add(new Month(current.ordinal() + 1, year), map.get(Severity.MEDIUM), "Medium");
            stackeddata.add(new Month(current.ordinal() + 1, year), map.get(Severity.LOW), "Low");
        }
        for(int i = 0; i < 6; i++){
            Map<Severity, Integer> map = data.getYear(i + 2015);
            griddata[i][0] = i + 2015;
            griddata[i][1] = map.get(Severity.LOW);
            griddata[i][2] = map.get(Severity.MEDIUM);
            griddata[i][3] = map.get(Severity.HIGH);
        }
    }

    private class StackedGraph extends ApplicationFrame implements Graph{

        private JFreeChart graph;

        public StackedGraph(String title){
            super(title);
            graph = ChartFactory.createStackedXYAreaChart(
                    "CVE Analysis",
                    "Month",
                    "Occurances",
                    stackeddata,
                    PlotOrientation.VERTICAL,  //
                    true,
                    true,
                    false
            );
            XYPlot plot = (XYPlot) graph.getPlot();
            plot.setDomainAxis(new DateAxis());
            JPanel chartPanel = new ChartPanel(graph);
            chartPanel.setPreferredSize(new java.awt.Dimension(500, 270));
            setContentPane(chartPanel);
            pack();
        }

        public void Draw(){
            setVisible(true);
        }
    }

    private class GridGraph implements Graph{

        private JFrame frame;

        //TODO rename Gridtotable
        public GridGraph(){
            String[] colnames = {"Year", "Low", "Medium", "High"};
            JTable table = new JTable(griddata, colnames);
            frame = new JFrame("Yearly CVEs");
            JScrollPane pane = new JScrollPane(table);
            frame.add(pane);
            frame.setSize(300, 500);
        }

        public void Draw() {
            frame.setVisible(true);
        }
    }

    public Graph stackedAreaChart(){
        return new StackedGraph("CVE Stacked Area");
    }

    public Graph gridChart(){
        return new GridGraph();
    }


}


