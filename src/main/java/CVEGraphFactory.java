import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.axis.DateAxis;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.plot.XYPlot;
import org.jfree.chart.ui.ApplicationFrame;
import org.jfree.data.time.TimeTableXYDataset;
import org.jfree.data.time.Month;
import javax.swing.*;
import java.util.Map;


/**Produce graphs specific for CVE data.
 */
public class CVEGraphFactory{

    //Processed data for graphical display
    private TimeTableXYDataset stackeddata;
    private Integer[][] griddata;

    private CVEGraphFactory(){ }

    /**Load and format CVE data for graphical display.
     */
    private void initialise(){
        DataByPeriod<Severity, Integer> data = (DataByPeriod)Launch.getContext().getBean("DataByPeriod");
        stackeddata = new TimeTableXYDataset();
        griddata = new Integer[Launch.years][4];
        //get monthly figures for graphical display
        for(int i = 0; i < (12*Launch.years); i++){
            java.time.Month current = java.time.Month.of((i % 12) +1);
            int year = Launch.start+(i / 12);
            Map<Severity, Integer> map = data.getMonth(current, year);
            stackeddata.add(new Month(current.ordinal() + 1, year), map.get(Severity.HIGH), "High");
            stackeddata.add(new Month(current.ordinal() + 1, year), map.get(Severity.MEDIUM), "Medium");
            stackeddata.add(new Month(current.ordinal() + 1, year), map.get(Severity.LOW), "Low");
        }
        //get yearly figures for tabular display
        for(int i = 0; i < 6; i++){
            Map<Severity, Integer> map = data.getYear(i + 2015);
            griddata[i][0] = i + 2015;
            griddata[i][1] = map.get(Severity.LOW);
            griddata[i][2] = map.get(Severity.MEDIUM);
            griddata[i][3] = map.get(Severity.HIGH);
        }
    }

    private class StackedGraph extends ApplicationFrame implements Graph{

        private JFreeChart graph;

        public StackedGraph(){
            super("CVE Stacked Area");
            //configure graph
            graph = ChartFactory.createStackedXYAreaChart(
                    "CVE Analysis",
                    "Month",
                    "Occurances",
                    stackeddata,
                    PlotOrientation.VERTICAL,  //
                    true,
                    true,
                    false
            );
            XYPlot plot = (XYPlot) graph.getPlot();
            plot.setDomainAxis(new DateAxis());
            JPanel chartPanel = new ChartPanel(graph);
            chartPanel.setPreferredSize(new java.awt.Dimension(500, 270));
            setContentPane(chartPanel);
            pack();
        }

        public void Draw(){
            setVisible(true);
        }
    }

    private class TableGraph implements Graph{

        private JFrame frame;

        public TableGraph(){
            //configure table
            String[] colnames = {"Year", "Low", "Medium", "High"};
            JTable table = new JTable(griddata, colnames);
            frame = new JFrame("Yearly CVEs");
            JScrollPane pane = new JScrollPane(table);
            frame.add(pane);
            frame.setSize(300, 200);
        }

        public void Draw() {
            frame.setVisible(true);
        }
    }

    /**
     * @return StackedAreaGraph for CVE data
     */
    public Graph stackedAreaChart(){ return new StackedGraph();
    }

    /**
     *
     * @return TableGraph for CVE data
     */
    public Graph tableChart(){
        return new TableGraph();
    }


}


